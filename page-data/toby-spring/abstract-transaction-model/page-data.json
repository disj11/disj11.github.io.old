{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/toby-spring/abstract-transaction-model/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Dev Logs","author":"tykim","siteUrl":"https://disj11.github.io/old","comment":{"disqusShortName":"","utterances":"disj11/disj11.github.io"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"e6594256-e3a2-5920-bedb-a5462ae0dc66","excerpt":"개요 트랜잭션 기능을 사용한 서비스를 리팩토링 해가며 스프링에서 트랜젝션 서비스를 어떤 방식으로 제공해 주는지 알아보자. Service…","html":"<h2 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h2>\n<p>트랜잭션 기능을 사용한 서비스를 리팩토링 해가며 스프링에서 트랜젝션 서비스를 어떤 방식으로 제공해 주는지 알아보자.</p>\n<h2 id=\"service\" style=\"position:relative;\"><a href=\"#service\" aria-label=\"service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Service</h2>\n<p>다음과 같이 사용자의 등급을 올리는 서비스 메서드가 있다고 하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">upgradeLevels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> users <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token operator\">:</span> users<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            user<span class=\"token punctuation\">.</span><span class=\"token function\">upgradeLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            userDao<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 서비스는 작업을 수행하는 도중 오류가 발생하여도, 오류가 발생하기 전까지 변경된 사용자의 레벨은 변경된 상태로 유지된다. 오류가 발생할 경우 변경된 내용을 모두 원 상태로 되돌리고 싶다면 트랜잭션 기능을 도입해야 할 것이다.</p>\n<h2 id=\"트랜잭션-경계-설정\" style=\"position:relative;\"><a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B2%BD%EA%B3%84-%EC%84%A4%EC%A0%95\" aria-label=\"트랜잭션 경계 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>트랜잭션 경계 설정</h2>\n<p>모든 트랜잭션은 시작 지점과 끝나는 지점이 있다. 어플리케이션 내에서 트랜잭션이 시작되고 끝나는 위치를 트랜잭션 경계라고 부른다. 다음은 JDBC를 사용하여 트랜잭션을 적용하는 예제이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Connection</span> c <span class=\"token operator\">=</span> dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">setAutoCommit</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 시작</span>\n\n    <span class=\"token class-name\">PreparedStatement</span> pstmt1 <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update users ...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    pstmt1<span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">PreparedStatement</span> pstmt2 <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delete users ...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    pstmt2<span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 커밋</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 롤백</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 <code class=\"language-text\">setAutoCommit(false)</code> 로 트랜잭션을 시작하고 <code class=\"language-text\">commit()</code> 또는 <code class=\"language-text\">rollback()</code> 을 사용하여 트랜잭션을 종료하는 작업을 <strong>트랜잭션의 경계설정</strong>이라고 한다.</p>\n<h2 id=\"트랜잭션-도입시-문제점-1\" style=\"position:relative;\"><a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EB%8F%84%EC%9E%85%EC%8B%9C-%EB%AC%B8%EC%A0%9C%EC%A0%90-1\" aria-label=\"트랜잭션 도입시 문제점 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>트랜잭션 도입시 문제점 1</h2>\n<p>스프링의 <code class=\"language-text\">JdbcTemplate</code> 은 내부적으로 getConnection() 메서드를 호출하여 Connection 오브젝트를 가져오고, 작업이 종료될 때 Connection을 닫는다. 앞에서 작성한 <a href=\"#Service\">UserService</a>에 사용된 UserDao에 JdbcTemplate을 사용했다고 한다면, UserDao는 각 메서드마다 독립적인 트랜잭션으로 실행될 수 밖에 없다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1107px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVQoz02RC4vCQAyE+/9/mlAQEbFbLfZ8tFrbun2Jzzm+wB4XGLrNJpOZbFTXtdI01X6/1+120ziO6vtel8tFm81GTdOo6zp9v187F0UheqgdhkHE5/P5Q7RerxXHsZxzRkbzNE3a7Xaaz+c2CILD4aCyLOVcqiRJdL/fdb1e9Xq99D+i7XYr5xIjhAy1NB+PR1MJWVkWqqrKCBkEUOq9txzKOeMsyvMfLZdLLRYLS85mM2VZZspQQbRtY4Sn08kGQvh4PMw2eVaD6rZtFT2fT7NIM2eKKSTYG3E+n01t13kjzfPciHAUFHI2heyN5UIa9sc/l3yB951ZZ9hqtRJr4p5B1L/fb4M9CksNCMlQAMiTI4I9HhJ7CAhOAn4BJugRKVCliFMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"트랜잭션 처리 과정\"\n        title=\"트랜잭션 처리 과정\"\n        src=\"/static/c8fdb6efde3f6e8c2b63be5d78b8bf03/d7ba6/transaction-process-flow.png\"\n        srcset=\"/static/c8fdb6efde3f6e8c2b63be5d78b8bf03/5a46d/transaction-process-flow.png 300w,\n/static/c8fdb6efde3f6e8c2b63be5d78b8bf03/0a47e/transaction-process-flow.png 600w,\n/static/c8fdb6efde3f6e8c2b63be5d78b8bf03/d7ba6/transaction-process-flow.png 1107w\"\n        sizes=\"(max-width: 1107px) 100vw, 1107px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이 문제를 해결하려면 UserService에서 Connection 객체를 생성하고, UserDao 메서드로 생성된 Connection을 파라미터로 전달해 같은 Connection을 사용하도록 해야한다. 이렇게 변경된 코드는 다음과 같을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">upgradeLevels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Connection</span> c <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            c<span class=\"token punctuation\">.</span><span class=\"token function\">setAutoCommit</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> users <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token operator\">:</span> users<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                user<span class=\"token punctuation\">.</span><span class=\"token function\">upgradeLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userDao<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// dao로 connection 전달</span>\n            <span class=\"token punctuation\">}</span>\n            c<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            c<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 적용하면 문제가 해결된 것일까?</p>\n<h2 id=\"트랜잭션-도입시-문제점-2\" style=\"position:relative;\"><a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EB%8F%84%EC%9E%85%EC%8B%9C-%EB%AC%B8%EC%A0%9C%EC%A0%90-2\" aria-label=\"트랜잭션 도입시 문제점 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>트랜잭션 도입시 문제점 2</h2>\n<p>코드를 변경하여 트랜잭션 문제를 해결할 수 있겠지만, 그 이외의 여러 문제점이 생겼다.</p>\n<p>첫번째 문제는 <code class=\"language-text\">JdbcTemplate</code> 을 더 이상 사용하지 못하게 된다는 것이다. 결국 JDBC API 를 직접 사용해야 하는 고전적인 방식을 사용해야 한다.</p>\n<p>두번째 문제는 DAO 메서드에 Connection 파라미터가 추가돼야 한다는 것이다. 클라이언트에서 <code class=\"language-text\">upgradeLevels()</code> 메서드를 사용하고 싶다면, 그 사이에 모든 메서드에 걸쳐서 Connection 객체가 전달 되어야 한다.</p>\n<p>세번째 문제는 UserDao가 더 이상 데이터 액세스 기술에 독립적이지 않다는 것이다. UserDao가 JDBC가 아닌 JPA로 구현 방식을 변경하고 싶다면 Connection 대신 EntityManager를 전달 받도록 변경해야 한다.</p>\n<h2 id=\"문제-해결-1---트랜잭션-동기화\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-1---%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EB%8F%99%EA%B8%B0%ED%99%94\" aria-label=\"문제 해결 1   트랜잭션 동기화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 1 - 트랜잭션 동기화</h2>\n<p>스프링에서는 Connection을 파라미터로 전달하는 문제를 해결하기위해 <strong>트랜잭션 동기화</strong> 방식을 사용한다. 트랜잭션 동기화란 트랜잭션을 위해 생성한 Connection 객체를 특별한 저장소에 보관해두고, 이후에 <code class=\"language-text\">JdbcTemplate</code>이 사용될 때 저장된 Connection을 가져다가 사용하게 하는 것이다. 이후 모든 트랜잭션이 종료되면 그때 동기화를 마치면 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 605px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABB0lEQVQY00XQ247rIAwF0Pz/B/ahOqqmDYlDi4MTx1xDmCOY0axHmy3bDLVJKR2Nc8577xpjjNbaey+N+3VdV08NvtFaI2IIwVq7risiGmMQ0Vr7+XyI6DgOIlrXdZqm3iKigZlFRCm1LItzrle11gCglHq9XgCAiPu+G2Pmee6VeZ4RcbANETFzjNE5V2s9z7OUklLqj0Sk1tq33ff9PM+ftZl5HMfb7WaMqbUCwPv9BoDH4/Gvud/vAJBz7gER6eHruoZ+jFKKmWutz+fzqxnHkYhCCN77EAIiTtO0LMtxHH8ftm2biDCz9z7GSEQism1bzjmllHMupcQYmTnnHGMspfTk/8nfV7KM7vY7PdsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"트랜잭션 동기화를 사용할 경우의 작업 흐름\"\n        title=\"트랜잭션 동기화를 사용할 경우의 작업 흐름\"\n        src=\"/static/8f9de69fde89f9bcac326e06c5f61339/90cbd/transaction-synchronizations-flow.png\"\n        srcset=\"/static/8f9de69fde89f9bcac326e06c5f61339/5a46d/transaction-synchronizations-flow.png 300w,\n/static/8f9de69fde89f9bcac326e06c5f61339/0a47e/transaction-synchronizations-flow.png 600w,\n/static/8f9de69fde89f9bcac326e06c5f61339/90cbd/transaction-synchronizations-flow.png 605w\"\n        sizes=\"(max-width: 605px) 100vw, 605px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>다음은 트랜잭션 동기화를 적용한 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">upgradeLevels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">TransactionSynchronizationManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">initSynchronization</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 동기화 관리자를 사용해 동기화 작업 초기화</span>\n    <span class=\"token class-name\">Connection</span> c <span class=\"token operator\">=</span> <span class=\"token class-name\">DataSourceUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span>dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">setAutoCommit</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// DB 커넥션 닫기</span>\n        <span class=\"token class-name\">DataSourceUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">releaseConnection</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 동기화 작업 종료 및 정리</span>\n        <span class=\"token class-name\">TransactionSynchronizationManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">unbindResource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">TransactionSynchronizationManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">clearSynchronization</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">DataSourceUtils</code> 에서 제공하는 <code class=\"language-text\">getConnection()</code> 메서드를 사용한 이유는 이 메서드가 Connection 객체를 반환할 뿐만 아니라 트랜잭션 동기화에 사용하도록 저장소에 바인딩 하는 역할을 해주기 때문이다.</p>\n<p><code class=\"language-text\">JdbcTemplate</code> 은 트랜잭션 동기화를 시작해 놓았다면 새로운 DB 커넥션을 만드는 대신 트랜잭션 동기화 저장소에 들어 있는 DB 커넥션을 가져와서 사용하도록 되어있다.</p>\n<p>이렇게 트랜잭션 동기화를 통해 Connection 파라미터를 없앴지만, 여전히 문제가 남아있다. 트랜잭션 처리가 JDBC의 Connction을 사용하는 방식에 종속적이라는 것이다. 예를들어 두 개 이상의 DB에 데이터를 저장하는 작업을 하나의 트랜잭션으로 만들기 위해서는 JDBC의 Connection을 이용한 트랜잭션 방식인 로컬 트랜잭션으로는 불가능하다. 이를 해결하기 위해서는 글로벌 트랜잭션 방식을 사용해야 한다.</p>\n<p>자바는 글로벌 트랜잭션을 지원하기 위한 API인 JTA를 제공한다. JTA를 이용한 트랜잭션 코드는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">InitialContext</span> ctx <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InitailContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">UserTransaction</span> tx <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">UserTransaction</span><span class=\"token punctuation\">)</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>USER_TX_JNDI_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ntx<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Connection</span> c <span class=\"token operator\">=</span> dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tx<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tx<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그렇다면 구현 기술이 바뀔때마다 코드를 수정해야 하는 걸까?</p>\n<h2 id=\"문제-해결-2---서비스-추상화\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-2---%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%B6%94%EC%83%81%ED%99%94\" aria-label=\"문제 해결 2   서비스 추상화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 2 - 서비스 추상화</h2>\n<p>이러한 문제를 해결하기 위해 스프링에서는 트랜잭션 기술의 공통점을 담은 트랜잭션 추상화 기술을 제공한다. 이를 이용하여 각 기술의 트랜잭션 API를 이용하지 않고 일관된 방식으로 트랜잭션 제어가 가능하다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 735px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUklEQVQoz1XQXW7DIAwA4Nz/Wj1ApbxVKZR/DEGQBgRp05RpsFXb94CMZBvj4f1HrTXGmFJaliWEEGPsQa31OI5aawhBCAEAOeda61D/Syk55xhj1+tVNQBQa+2tX6/X4/HY9733GgBA/+INIYQxdj6fSUMpVUr1BGOMUspa+2i+X+6d9n333kspGWPjOJ5OJ4QQIURKuW3b+/1+Nc/nk1IKAN774TPScRwxRiEExniapnEcEULTNAHAZ86eZq3tJcO2bTnnGOO6rv0sTQihlJJzTs39fo8xllJSSkqpn+L+SUopxpg2nPMeoAYApJQ9AWPc4z7FYIyx1iKEOOfGGGiMMZfLBX5Zaxljt9ttnmcppdb6p3ieZ+89IURrHULQWrsGY+ycs9b23UgpOefee+fcsiyllO9tG2M451JKIYRzTjaccyHEJ+gJ/doHsdau6/oF9k4rebKJTUQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"스프링의 트랜잭션 추상화 계층\"\n        title=\"스프링의 트랜잭션 추상화 계층\"\n        src=\"/static/ae8fbaf5684f584dc899570c7a13201b/7608e/abstract-transaction-model-layer.png\"\n        srcset=\"/static/ae8fbaf5684f584dc899570c7a13201b/5a46d/abstract-transaction-model-layer.png 300w,\n/static/ae8fbaf5684f584dc899570c7a13201b/0a47e/abstract-transaction-model-layer.png 600w,\n/static/ae8fbaf5684f584dc899570c7a13201b/7608e/abstract-transaction-model-layer.png 735w\"\n        sizes=\"(max-width: 735px) 100vw, 735px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>스프링이 제공하는 트랜잭션 추상화 방법을 적용한 코드는 다음과 같다.</p>\n<div id=\"user-service\">\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">PlatformTransactionManager</span> transactionManager<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setTransactionManager</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PlanformTransactionManager</span> transactionManager<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>trasactionManager <span class=\"token operator\">=</span> transactionManager<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">upgradeLevels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">TransactionStatus</span> status <span class=\"token operator\">=</span> transactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">getTransaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultTransactionDefinition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 시작</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> users <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token operator\">:</span> users<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                user<span class=\"token punctuation\">.</span><span class=\"token function\">upgradeLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userDao<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            transactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 커밋</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RunctimeException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            transactionManager<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 롤백</span>\n            <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</div>\n<p>스프링이 제공하는 트랜잭션 경계설정을 위한 추상 인터페이스는 <code class=\"language-text\">PlatformTransactionManager</code> 이다. JDBC의 로컬 트랜잭션을 사용한다면 <code class=\"language-text\">PlatformTransactionManager</code> 의 구현체인 <code class=\"language-text\">DataSourceTransactionManager</code> 를 사용하면 된다. 만약 글로벌 트랜잭션 사용을 위하여 JTA를 이용하도록 변경하고 싶다면 <code class=\"language-text\">DataSourceTransactionManager</code> 대신 <code class=\"language-text\">JTATransactionManager</code> 을 사용하도록 변경하면 된다.</p>","frontmatter":{"title":"트랜잭션 서비스 추상화","date":"September 27, 2021"}}},"pageContext":{"slug":"/toby-spring/abstract-transaction-model/","previous":{"fields":{"slug":"/toby-spring/template-callback/"},"frontmatter":{"title":"템플릿/콜백 패턴의 이해"}},"next":{"fields":{"slug":"/toby-spring/proxy-1-proxy-and-pattern/"},"frontmatter":{"title":"프록시 1 - 프록시와 프록시를 사용한 패턴"}}}},
    "staticQueryHashes": ["3078735561","3128451518"]}